/* pvm-insns-test.pk - Tests for PVM instructions.  */

/* Copyright (C) 2023 Jose E. Marchesi.  */

/* This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

/* When testing instructions that push new values on the stack, such
   as addi for example, please make sure to also check that the
   new values are of the right type.  So for example, instead of this:

     var res = asm int<32>: ("muli; nip2" : 2, 3);
     assert (res == 6);

   it is much more useful to do this:

     var res = asm any: ("muli; nip2" : 2, 3);
     assert (res isa int<32>);
     assert (res as int<32> == 6);
*/

load pktest;

var tests = [
  /* VM related instructions.  */
  PkTest {
    name = "pushend and popend",
    func = lambda (string name) void:
      {
        asm ("popend" :: 0);
        assert (asm int<32>: ("pushend") == 0);
        asm ("popend" :: 1);
        assert (asm int<32>: ("pushend") == 1);
      },
  },
  PkTest {
    name = "pushob and popob",
    func = lambda (string name) void:
      {
        asm ("popob" :: 2);
        assert (asm int<32>: ("pushob") == 2);
        asm ("popob" :: 10);
        assert (asm int<32>: ("pushob") == 10);
      }
  },
  PkTest {
    name = "pushom and popom",
    func = lambda (string name) void:
      {
        asm ("popom" :: 0);
        assert (asm int<32>: ("pushom") == 0);
        asm ("popom" :: 1);
        assert (asm int<32>: ("pushom") == 1);
      }
  },
  PkTest {
    name = "pushoo and popoo",
    func = lambda (string name) void:
      {
        asm ("popoo" :: 0);
        assert (asm int<32>: ("pushoo") == 0);
        asm ("popoo" :: 1);
        assert (asm int<32>: ("pushoo") == 1);
      }
  },
  PkTest {
    name = "pushoi and popoi",
    func = lambda (string name) void:
      {
        asm ("popoi" :: 0);
        assert (asm int<32>: ("pushoi") == 0);
        asm ("popoi" :: 1);
        assert (asm int<32>: ("pushoi") == 1);
      }
  },
  PkTest {
    name = "pushod and popod",
    func = lambda (string name) void:
      {
        asm ("popod" :: 0);
        assert (asm int<32>: ("pushod") == 0);
        asm ("popod" :: 1);
        assert (asm int<32>: ("pushod") == 1);
      }
  },
  PkTest {
    name = "pushoac and popoac",
    func = lambda (string name) void:
      {
        asm ("popoac" :: 0);
        assert (asm int<32>: ("pushoac") == 0);
        asm ("popoac" :: 1);
        assert (asm int<32>: ("pushoac") == 1);
      }
  },
  PkTest {
    name = "pushopp and popopp",
    func = lambda (string name) void:
      {
        asm ("popopp" :: 0);
        assert (asm int<32>: ("pushopp") == 0);
        asm ("popopp" :: 1);
        assert (asm int<32>: ("pushopp") == 1);
      }
  },
  /* Integer overflow instructions.  */
  PkTest {
    name = "addiof",
    func = lambda (string name) void:
      {
        var res = asm any: ("addiof; nip2" : 2, 3);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("addiof; nip2" : 0xffff, 0x7fff_ffff);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "addlof",
    func = lambda (string name) void:
      {
        var res = asm any: ("addlof; nip2" : 2L, 3L);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("addlof; nip2" : 0x7fff_ffff_ffff_ffff, 1L);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "subiof",
    func = lambda (string name) void:
      {
        var res = asm any: ("subiof; nip2" : 3, 2);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("subiof; nip2" : 0b0111 as int<4>, 0b1010 as int<4>);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "sublof",
    func = lambda (string name) void:
      {
        var res = asm any: ("sublof; nip2" : 2L, 3L);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("sublof; nip2" : 0x8000_0000_0000_0000LU as int<64>,
                                         1L);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "muliof",
    func = lambda (string name) void:
      {
        var res = asm any: ("muliof; nip2" : 2, 3);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("muliof; nip2" : 0xffff, 0x7fff_ffff);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "mullof",
    func = lambda (string name) void:
      {
        var res = asm any: ("mullof; nip2" : 2L, 3L);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("mullof; nip2" : 0x7fff_ffff_ffff_ffff, 2L);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "diviof",
    func = lambda (string name) void:
      {
        var res = asm any: ("diviof; nip2" : 10, 2);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("diviof; nip2" : 0x8000_0000U as int<32>, -1);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "divlof",
    func = lambda (string name) void:
      {
        var res = asm any: ("divlof; nip2" : 2L, 3L);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("divlof; nip2" : 0x8000_0000_0000_0000LU as int<64>, -1L);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "modiof",
    func = lambda (string name) void:
      {
        var res = asm any: ("modiof; nip2" : 10, 2);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("modiof; nip2" : 0x8000_0000U as int<32>, -1);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "modlof",
    func = lambda (string name) void:
      {
        var res = asm any: ("modlof; nip2" : 2L, 3L);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("modlof; nip2" : 0x8000_0000_0000_0000LU as int<64>, -1L);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "negiof",
    func = lambda (string name) void:
      {
        var res = asm any: ("negiof; nip" : 10);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("negiof; nip" : 0x8000_0000U as int<32>);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "neglof",
    func = lambda (string name) void:
      {
        var res = asm any: ("neglof; nip" : 2L);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("neglof; nip" : 0x8000_0000_0000_0000LU as int<64>);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "powiof",
    func = lambda (string name) void:
      {
        var res = asm any: ("powiof; nip2" : 2, 6U);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("powiof; nip2" : 2, 31);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "powlof",
    func = lambda (string name) void:
      {
        var res = asm any: ("powlof; nip2" : 2L, 3U);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("powlof; nip2" : 2L, 63);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  /* Arithmetic instructions.  */
  PkTest {
    name = "addi",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("addi; nip2" : 1, 2) == 3);
        var i3 = asm int<3>: ("addi; nip2" : 1 as int<3>, 2 as int<3>);
        assert (i3 isa int<3> && i3 == 3);
      }
  },
  PkTest {
    name = "addiu",
    func = lambda (string name) void:
      {
        assert (asm uint<32>: ("addiu; nip2" : 1U, 2U) == 3U);
        var u5 = asm uint<5>: ("addiu; nip2" : 1 as uint<5>, 2 as uint<5>);
        assert (u5 isa uint<5> && u5 == 3U);
      }
  },
  PkTest {
    name = "addl",
    func = lambda (string name) void:
      {
        assert (asm int<64>: ("addl; nip2" : 1L, 2L) == 3);
        var i34 = asm int<34>: ("addl; nip2" : 1 as int<34>, 2 as int<34>);
        assert (i34 isa int<34> && i34 == 3);
      }
  },
  PkTest {
    name = "addlu",
    func = lambda (string name) void:
      {
        assert (asm uint<64>: ("addlu; nip2" : 1UL, 2UL) == 3UL);
        var u35 = asm uint<35>: ("addlu; nip2" : 1 as uint<35>, 2 as uint<35>);
        assert (u35 isa uint<35> && u35 == 3LU);
      }
  },
  /* Floating-point instructions.  */
  PkTest {
    name = "stof",
    func = lambda (string name) void:
      {
        var pi1 = asm any: ("stof" : "3.14159265359");

        assert (pi1 isa uint<32>);
        assert (pi1 as uint<32> == 0x40490fdbU);

        /* Non-OK cases.  */
        assert (asm int<32>: ("stof; nnn; nip" : "  "));
        assert (asm int<32>: ("stof; nnn; nip" : "+"));
        assert (asm int<32>: ("stof; nnn; nip" : "  +"));
        assert (asm int<32>: ("stof; nnn; nip" : "  +1 "));
        assert (asm int<32>: ("stof; nnn; nip" : "a"));

        /* OK cases.  */
        assert (asm int<32>: ("stof; nn; nip" : "  +1"));
        assert (asm int<32>: ("stof; nn; nip" : ""));
        assert (asm int<32>: ("stof; nn; nip" : "-1E9"));
      }
  },
  PkTest {
    name = "stod",
    func = lambda (string name) void:
      {
        var pi1 = asm any: ("stod" : "3.14159265359");

        assert (pi1 isa uint<64>);
        assert (pi1 as uint<64> == 0x400921fb54442eeaUL);

        /* Non-OK cases.  */
        assert (asm int<32>: ("stod; nnn; nip" : "  "));
        assert (asm int<32>: ("stod; nnn; nip" : "+"));
        assert (asm int<32>: ("stod; nnn; nip" : "  +"));
        assert (asm int<32>: ("stod; nnn; nip" : "  +1 "));
        assert (asm int<32>: ("stod; nnn; nip" : "a"));

        /* OK cases.  */
        assert (asm int<32>: ("stod; nn; nip" : "  +1"));
        assert (asm int<32>: ("stod; nn; nip" : ""));
        assert (asm int<32>: ("stod; nn; nip" : "-1E9"));
      }
  },
];

var ok = pktest_run (tests);
exit (ok ? 0 : 1);
