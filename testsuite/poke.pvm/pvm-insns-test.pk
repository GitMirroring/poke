/* pvm-insns-test.pk - Tests for PVM instructions.  */

/* Copyright (C) 2023, 2024, 2025 Jose E. Marchesi.  */

/* This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

/* When testing instructions that push new values on the stack, such
   as addi for example, please make sure to also check that the
   new values are of the right type.  So for example, instead of this:

     var res = asm int<32>: ("muli; nip2" : 2, 3);
     assert (res == 6);

   it is much more useful to do this:

     var res = asm any: ("muli; nip2" : 2, 3);
     assert (res isa int<32>);
     assert (res as int<32> == 6);
*/

load pktest;

var tests = [
  /* VM related instructions.  */
  PkTest {
    name = "pushend and popend",
    func = lambda (string name) void:
      {
        asm ("popend" :: 0);
        assert (asm int<32>: ("pushend") == 0);
        asm ("popend" :: 1);
        assert (asm int<32>: ("pushend") == 1);
      },
  },
  PkTest {
    name = "pushob and popob",
    func = lambda (string name) void:
      {
        asm ("popob" :: 2);
        assert (asm int<32>: ("pushob") == 2);
        asm ("popob" :: 10);
        assert (asm int<32>: ("pushob") == 10);
      }
  },
  PkTest {
    name = "pushom and popom",
    func = lambda (string name) void:
      {
        asm ("popom" :: 0);
        assert (asm int<32>: ("pushom") == 0);
        asm ("popom" :: 1);
        assert (asm int<32>: ("pushom") == 1);
      }
  },
  PkTest {
    name = "pushoo and popoo",
    func = lambda (string name) void:
      {
        asm ("popoo" :: 0);
        assert (asm int<32>: ("pushoo") == 0);
        asm ("popoo" :: 1);
        assert (asm int<32>: ("pushoo") == 1);
      }
  },
  PkTest {
    name = "pushoi and popoi",
    func = lambda (string name) void:
      {
        asm ("popoi" :: 0);
        assert (asm int<32>: ("pushoi") == 0);
        asm ("popoi" :: 1);
        assert (asm int<32>: ("pushoi") == 1);
      }
  },
  PkTest {
    name = "pushod and popod",
    func = lambda (string name) void:
      {
        asm ("popod" :: 0);
        assert (asm int<32>: ("pushod") == 0);
        asm ("popod" :: 1);
        assert (asm int<32>: ("pushod") == 1);
      }
  },
  PkTest {
    name = "pushoac and popoac",
    func = lambda (string name) void:
      {
        asm ("popoac" :: 0);
        assert (asm int<32>: ("pushoac") == 0);
        asm ("popoac" :: 1);
        assert (asm int<32>: ("pushoac") == 1);
      }
  },
  PkTest {
    name = "pushopp and popopp",
    func = lambda (string name) void:
      {
        asm ("popopp" :: 0);
        assert (asm int<32>: ("pushopp") == 0);
        asm ("popopp" :: 1);
        assert (asm int<32>: ("pushopp") == 1);
      }
  },
  /* IOS related instructions.  */
  PkTest {
    name = "isios",
    func = lambda (string name) void:
      {
        var is_ios = asm any: ("isios; nip" : 10);

        assert (is_ios isa int<32>);
        assert (is_ios as int<32> == 0);

        is_ios = asm any: ("isios; nip" : -1);

        assert (is_ios isa int<32>);
        assert (is_ios as int<32> == 0);

        with_temp_ios
          :do lambda void:
            {
              assert (asm int<32>: ("isios; nip" : get_ios) == 1);
            };
      }
  },
  PkTest {
    name = "iotype",
    func = lambda (string name) void:
      {
        with_temp_ios
          :do lambda void:
            {
              assert (asm string: ("iotype; nip" : get_ios)
                      == "MEMORY");
            };
      }
  },
  PkTest {
    name = "iogetv",
    func = lambda (string name) void:
      {
        with_temp_ios
          :do lambda void:
            {
              /* Memory IO spaces are non-volatile by default.  */
              assert (asm int<32>: ("iogetv; nip" : get_ios)
                      == 0);
            };
      }
  },
  /* Integer overflow instructions.  */
  PkTest {
    name = "addiof",
    func = lambda (string name) void:
      {
        var res = asm any: ("addiof; nip2" : 2, 3);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("addiof; nip2" : 0xffff, 0x7fff_ffff);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "addlof",
    func = lambda (string name) void:
      {
        var res = asm any: ("addlof; nip2" : 2L, 3L);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("addlof; nip2" : 0x7fff_ffff_ffff_ffff, 1L);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "subiof",
    func = lambda (string name) void:
      {
        var res = asm any: ("subiof; nip2" : 3, 2);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("subiof; nip2" : 0b0111 as int<4>, 0b1010 as int<4>);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "sublof",
    func = lambda (string name) void:
      {
        var res = asm any: ("sublof; nip2" : 2L, 3L);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("sublof; nip2" : 0x8000_0000_0000_0000LU as int<64>,
                                         1L);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "muliof",
    func = lambda (string name) void:
      {
        var res = asm any: ("muliof; nip2" : 2, 3);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("muliof; nip2" : 0xffff, 0x7fff_ffff);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "mullof",
    func = lambda (string name) void:
      {
        var res = asm any: ("mullof; nip2" : 2L, 3L);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("mullof; nip2" : 0x7fff_ffff_ffff_ffff, 2L);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "diviof",
    func = lambda (string name) void:
      {
        var res = asm any: ("diviof; nip2" : 10, 2);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("diviof; nip2" : 0x8000_0000U as int<32>, -1);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "divlof",
    func = lambda (string name) void:
      {
        var res = asm any: ("divlof; nip2" : 2L, 3L);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("divlof; nip2" : 0x8000_0000_0000_0000LU as int<64>, -1L);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "modiof",
    func = lambda (string name) void:
      {
        var res = asm any: ("modiof; nip2" : 10, 2);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("modiof; nip2" : 0x8000_0000U as int<32>, -1);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "modlof",
    func = lambda (string name) void:
      {
        var res = asm any: ("modlof; nip2" : 2L, 3L);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("modlof; nip2" : 0x8000_0000_0000_0000LU as int<64>, -1L);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "negiof",
    func = lambda (string name) void:
      {
        var res = asm any: ("negiof; nip" : 10);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("negiof; nip" : 0x8000_0000U as int<32>);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "neglof",
    func = lambda (string name) void:
      {
        var res = asm any: ("neglof; nip" : 2L);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("neglof; nip" : 0x8000_0000_0000_0000LU as int<64>);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "powiof",
    func = lambda (string name) void:
      {
        var res = asm any: ("powiof; nip2" : 2, 6U);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("powiof; nip2" : 2, 31);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  PkTest {
    name = "powlof",
    func = lambda (string name) void:
      {
        var res = asm any: ("powlof; nip2" : 2L, 3U);
        assert (res isa int<32>);
        assert (res as int<32> == 0);
        res = asm any: ("powlof; nip2" : 2L, 63);
        assert (res isa int<32>);
        assert (res as int<32> == 1);
      }
  },
  /* Arithmetic instructions.  */
  PkTest {
    name = "addi",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("addi; nip2" : 1, 2) == 3);
        var i3 = asm int<3>: ("addi; nip2" : 1 as int<3>, 2 as int<3>);
        assert (i3 isa int<3> && i3 == 3);
      }
  },
  PkTest {
    name = "addiu",
    func = lambda (string name) void:
      {
        assert (asm uint<32>: ("addiu; nip2" : 1U, 2U) == 3U);
        var u5 = asm uint<5>: ("addiu; nip2" : 1 as uint<5>, 2 as uint<5>);
        assert (u5 isa uint<5> && u5 == 3U);
      }
  },
  PkTest {
    name = "addl",
    func = lambda (string name) void:
      {
        assert (asm int<64>: ("addl; nip2" : 1L, 2L) == 3);
        var i34 = asm int<34>: ("addl; nip2" : 1 as int<34>, 2 as int<34>);
        assert (i34 isa int<34> && i34 == 3);
      }
  },
  PkTest {
    name = "addlu",
    func = lambda (string name) void:
      {
        assert (asm uint<64>: ("addlu; nip2" : 1UL, 2UL) == 3UL);
        var u35 = asm uint<35>: ("addlu; nip2" : 1 as uint<35>, 2 as uint<35>);
        assert (u35 isa uint<35> && u35 == 3LU);
      }
  },
  PkTest {
    name = "subi",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("subi; nip2" : 1, 2) == -1);
        var i3 = asm int<3>: ("subi; nip2" : 1 as int<3>, 2 as int<3>);
        assert (i3 isa int<3> && i3 == -1);
      }
  },
  PkTest {
    name = "subiu",
    func = lambda (string name) void:
      {
        assert (asm uint<32>: ("subiu; nip2" : 10U, 2U) == 8U);
        var u5 = asm uint<5>: ("subiu; nip2" : 1 as uint<5>, 2 as uint<5>);
        assert (u5 isa uint<5> && u5 == 0b11111U);
      }
  },
  PkTest {
    name = "subl",
    func = lambda (string name) void:
      {
        assert (asm int<64>: ("subl; nip2" : 1L, 2L) == -1);
        var i34 = asm int<34>: ("subl; nip2" : 1 as int<34>, 2 as int<34>);
        assert (i34 isa int<34> && i34 == -1);
      }
  },
  PkTest {
    name = "sublu",
    func = lambda (string name) void:
      {
        assert (asm uint<64>: ("sublu; nip2" : 10UL, 2UL) == 8UL);
        var u35 = asm uint<35>: ("sublu; nip2" : 10 as uint<35>, 2 as uint<35>);
        assert (u35 isa uint<35> && u35 == 8);
      }
  },
  /* Floating-point instructions.  */
  PkTest {
    name = "stof",
    func = lambda (string name) void:
      {
        var pi1 = asm any: ("stof" : "3.14159265359");

        assert (pi1 isa uint<32>);
        assert (pi1 as uint<32> == 0x40490fdbU);

        /* Non-OK cases.  */
        assert (asm int<32>: ("stof; nnn; nip" : "  "));
        assert (asm int<32>: ("stof; nnn; nip" : "+"));
        assert (asm int<32>: ("stof; nnn; nip" : "  +"));
        assert (asm int<32>: ("stof; nnn; nip" : "  +1 "));
        assert (asm int<32>: ("stof; nnn; nip" : "a"));
        assert (asm int<32>: ("stof; nnn; nip" : ""));

        /* OK cases.  */
        assert (asm int<32>: ("stof; nn; nip" : "  +1"));
        assert (asm int<32>: ("stof; nn; nip" : "-1E9"));
      }
  },
  PkTest {
    name = "stod",
    func = lambda (string name) void:
      {
        var pi1 = asm any: ("stod" : "3.14159265359");

        assert (pi1 isa uint<64>);
        assert (pi1 as uint<64> == 0x400921fb54442eeaUL);

        /* Non-OK cases.  */
        assert (asm int<32>: ("stod; nnn; nip" : "  "));
        assert (asm int<32>: ("stod; nnn; nip" : "+"));
        assert (asm int<32>: ("stod; nnn; nip" : "  +"));
        assert (asm int<32>: ("stod; nnn; nip" : "  +1 "));
        assert (asm int<32>: ("stod; nnn; nip" : "a"));
        assert (asm int<32>: ("stod; nnn; nip" : ""));

        /* OK cases.  */
        assert (asm int<32>: ("stod; nn; nip" : "  +1"));
        assert (asm int<32>: ("stod; nn; nip" : "-1E9"));
      }
  },
  /* Relational instructions.  */
  PkTest {
    name = "eqi",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("eqi; nip2" : 1, 2) == 0);
        assert (asm int<32>: ("eqi; nip2" : 100, 100) == 1);
        assert (asm int<32>: ("eqi; nip2" : -200, -200) == 1);
        assert (asm int<32>: ("eqi; nip2" : 1 as int<3>, 2 as int<3>) == 0);
        assert (asm int<32>: ("eqi; nip2" : 1 as int<3>, 1 as int<3>) == 1);
      }
  },
  PkTest {
    name = "eqiu",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("eqiu; nip2" : 1U, 2U) == 0);
        assert (asm int<32>: ("eqiu; nip2" : 100U, 100U) == 1);
        assert (asm int<32>: ("eqiu; nip2" : 1 as uint<3>, 2 as uint<3>) == 0);
        assert (asm int<32>: ("eqiu; nip2" : 1 as uint<7>, 1 as uint<7>) == 1);
      }
  },
  PkTest {
    name = "eql",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("eql; nip2" : 1L, 2L) == 0);
        assert (asm int<32>: ("eql; nip2" : 100L, 100L) == 1);
        assert (asm int<32>: ("eql; nip2" : -200L, -200L) == 1);
        assert (asm int<32>: ("eql; nip2" : 1 as int<52>, 2 as int<52>) == 0);
        assert (asm int<32>: ("eql; nip2" : 1 as int<33>, 1 as int<33>) == 1);
      }
  },
  PkTest {
    name = "eqlu",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("eqlu; nip2" : 1UL, 2LU) == 0);
        assert (asm int<32>: ("eqlu; nip2" : 100LU, 100UL) == 1);
        assert (asm int<32>: ("eqlu; nip2" : 1 as uint<52>, 2 as uint<52>) == 0);
        assert (asm int<32>: ("eqlu; nip2" : 1 as uint<33>, 1 as uint<33>) == 1);
      }
  },
  PkTest {
    name = "eqs",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("eqs; nip2" : "", "") == 1);
        assert (asm int<32>: ("eqs; nip2" : "foo", "bar") == 0);
        assert (asm int<32>: ("eqs; nip2" : "fooquux", "bar") == 0);
        assert (asm int<32>: ("eqs; nip2" : "bar", "fooquux") == 0);
        assert (asm int<32>: ("eqs; nip2" : "foo bar", "foo bar") == 1);
      }
  },
  PkTest {
    name = "nei",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("nei; nip2" : 1, 2) == 1);
        assert (asm int<32>: ("nei; nip2" : 100, 100) == 0);
        assert (asm int<32>: ("nei; nip2" : -200, -200) == 0);
        assert (asm int<32>: ("nei; nip2" : 1 as int<3>, 2 as int<3>) == 1);
        assert (asm int<32>: ("nei; nip2" : 1 as int<3>, 1 as int<3>) == 0);
      }
  },
  PkTest {
    name = "neiu",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("neiu; nip2" : 1U, 2U) == 1);
        assert (asm int<32>: ("neiu; nip2" : 100U, 100U) == 0);
        assert (asm int<32>: ("neiu; nip2" : 1 as uint<3>, 2 as uint<3>) == 1);
        assert (asm int<32>: ("neiu; nip2" : 1 as uint<7>, 1 as uint<7>) == 0);
      }
  },
  PkTest {
    name = "nel",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("nel; nip2" : 1L, 2L) == 1);
        assert (asm int<32>: ("nel; nip2" : 100L, 100L) == 0);
        assert (asm int<32>: ("nel; nip2" : -200L, -200L) == 0);
        assert (asm int<32>: ("nel; nip2" : 1 as int<52>, 2 as int<52>) == 1);
        assert (asm int<32>: ("nel; nip2" : 1 as int<33>, 1 as int<33>) == 0);
      }
  },
  PkTest {
    name = "nelu",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("nelu; nip2" : 1UL, 2LU) == 1);
        assert (asm int<32>: ("nelu; nip2" : 100LU, 100UL) == 0);
        assert (asm int<32>: ("nelu; nip2" : 1 as uint<52>, 2 as uint<52>) == 1);
        assert (asm int<32>: ("nelu; nip2" : 1 as uint<33>, 1 as uint<33>) == 0);
      }
  },
  PkTest {
    name = "nes",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("nes; nip2" : "", "") == 0);
        assert (asm int<32>: ("nes; nip2" : "foo", "bar") == 1);
        assert (asm int<32>: ("nes; nip2" : "fooquux", "bar") == 1);
        assert (asm int<32>: ("nes; nip2" : "bar", "fooquux") == 1);
        assert (asm int<32>: ("nes; nip2" : "foo bar", "foo bar") == 0);
      }
  },
  PkTest {
    name = "lti",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("lti; nip2" : 1, 2) == 1);
        assert (asm int<32>: ("lti; nip2" : 100, 100) == 0);
        assert (asm int<32>: ("lti; nip2" : -200, -200) == 0);
        assert (asm int<32>: ("lti; nip2" : 1 as int<3>, 2 as int<3>) == 1);
        assert (asm int<32>: ("lti; nip2" : 2 as int<3>, 1 as int<3>) == 0);
      }
  },
  PkTest {
    name = "ltiu",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("ltiu; nip2" : 1U, 2U) == 1);
        assert (asm int<32>: ("ltiu; nip2" : 100U, 100U) == 0);
        assert (asm int<32>: ("ltiu; nip2" : 1 as uint<3>, 2 as uint<3>) == 1);
        assert (asm int<32>: ("ltiu; nip2" : 2 as uint<7>, 1 as uint<7>) == 0);
      }
  },
  PkTest {
    name = "ltl",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("ltl; nip2" : 1L, 2L) == 1);
        assert (asm int<32>: ("ltl; nip2" : 100L, 100L) == 0);
        assert (asm int<32>: ("ltl; nip2" : -200L, -200L) == 0);
        assert (asm int<32>: ("ltl; nip2" : 1 as int<52>, 2 as int<52>) == 1);
        assert (asm int<32>: ("ltl; nip2" : 2 as int<33>, 1 as int<33>) == 0);
      }
  },
  PkTest {
    name = "ltlu",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("ltlu; nip2" : 1UL, 2LU) == 1);
        assert (asm int<32>: ("ltlu; nip2" : 100LU, 100UL) == 0);
        assert (asm int<32>: ("ltlu; nip2" : 1 as uint<52>, 2 as uint<52>) == 1);
        assert (asm int<32>: ("ltlu; nip2" : 2 as uint<33>, 1 as uint<33>) == 0);
      }
  },
  PkTest {
    name = "lts",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("lts; nip2" : "", "") == 0);
        assert (asm int<32>: ("lts; nip2" : "foo", "bar") == 0);
        assert (asm int<32>: ("lts; nip2" : "bar", "foo") == 1);
      }
  },
  PkTest {
    name = "gti",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("gti; nip2" : 1, 2) == 0);
        assert (asm int<32>: ("gti; nip2" : 100, 100) == 0);
        assert (asm int<32>: ("gti; nip2" : -200, -200) == 0);
        assert (asm int<32>: ("gti; nip2" : 1 as int<3>, 2 as int<3>) == 0);
        assert (asm int<32>: ("gti; nip2" : 2 as int<3>, 1 as int<3>) == 1);
      }
  },
  PkTest {
    name = "gtiu",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("gtiu; nip2" : 1U, 2U) == 0);
        assert (asm int<32>: ("gtiu; nip2" : 100U, 100U) == 0);
        assert (asm int<32>: ("gtiu; nip2" : 1 as uint<3>, 2 as uint<3>) == 0);
        assert (asm int<32>: ("gtiu; nip2" : 2 as uint<7>, 1 as uint<7>) == 1);
      }
  },
  PkTest {
    name = "gtl",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("gtl; nip2" : 1L, 2L) == 0);
        assert (asm int<32>: ("gtl; nip2" : 100L, 100L) == 0);
        assert (asm int<32>: ("gtl; nip2" : -200L, -200L) == 0);
        assert (asm int<32>: ("gtl; nip2" : 1 as int<52>, 2 as int<52>) == 0);
        assert (asm int<32>: ("gtl; nip2" : 2 as int<33>, 1 as int<33>) == 1);
      }
  },
  PkTest {
    name = "gtlu",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("gtlu; nip2" : 1UL, 2LU) == 0);
        assert (asm int<32>: ("gtlu; nip2" : 100LU, 100UL) == 0);
        assert (asm int<32>: ("gtlu; nip2" : 1 as uint<52>, 2 as uint<52>) == 0);
        assert (asm int<32>: ("gtlu; nip2" : 2 as uint<33>, 1 as uint<33>) == 1);
      }
  },
  PkTest {
    name = "gts",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("gts; nip2" : "", "") == 0);
        assert (asm int<32>: ("gts; nip2" : "foo", "bar") == 1);
        assert (asm int<32>: ("gts; nip2" : "bar", "foo") == 0);
      }
  },
  PkTest {
    name = "lei",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("lei; nip2" : 1, 2) == 1);
        assert (asm int<32>: ("lei; nip2" : 100, 100) == 1);
        assert (asm int<32>: ("lei; nip2" : -200, -200) == 1);
        assert (asm int<32>: ("lei; nip2" : 1 as int<3>, 2 as int<3>) == 1);
        assert (asm int<32>: ("lei; nip2" : 2 as int<3>, 1 as int<3>) == 0);
      }
  },
  PkTest {
    name = "leiu",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("leiu; nip2" : 1U, 2U) == 1);
        assert (asm int<32>: ("leiu; nip2" : 100U, 100U) == 1);
        assert (asm int<32>: ("leiu; nip2" : 1 as uint<3>, 2 as uint<3>) == 1);
        assert (asm int<32>: ("leiu; nip2" : 2 as uint<7>, 1 as uint<7>) == 0);
      }
  },
  PkTest {
    name = "lel",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("lel; nip2" : 1L, 2L) == 1);
        assert (asm int<32>: ("lel; nip2" : 100L, 100L) == 1);
        assert (asm int<32>: ("lel; nip2" : -200L, -200L) == 1);
        assert (asm int<32>: ("lel; nip2" : 1 as int<52>, 2 as int<52>) == 1);
        assert (asm int<32>: ("lel; nip2" : 2 as int<33>, 1 as int<33>) == 0);
      }
  },
  PkTest {
    name = "lelu",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("lelu; nip2" : 1UL, 2LU) == 1);
        assert (asm int<32>: ("lelu; nip2" : 100LU, 100UL) == 1);
        assert (asm int<32>: ("lelu; nip2" : 1 as uint<52>, 2 as uint<52>) == 1);
        assert (asm int<32>: ("lelu; nip2" : 2 as uint<33>, 1 as uint<33>) == 0);
      }
  },
  PkTest {
    name = "les",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("les; nip2" : "", "") == 1);
        assert (asm int<32>: ("les; nip2" : "foo", "bar") == 0);
        assert (asm int<32>: ("les; nip2" : "bar", "foo") == 1);
      }
  },
  PkTest {
    name = "gti",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("gti; nip2" : 1, 2) == 0);
        assert (asm int<32>: ("gti; nip2" : 100, 100) == 0);
        assert (asm int<32>: ("gti; nip2" : -200, -200) == 0);
        assert (asm int<32>: ("gti; nip2" : 1 as int<3>, 2 as int<3>) == 0);
        assert (asm int<32>: ("gti; nip2" : 2 as int<3>, 1 as int<3>) == 1);
      }
  },
  PkTest {
    name = "gtiu",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("gtiu; nip2" : 1U, 2U) == 0);
        assert (asm int<32>: ("gtiu; nip2" : 100U, 100U) == 0);
        assert (asm int<32>: ("gtiu; nip2" : 1 as uint<3>, 2 as uint<3>) == 0);
        assert (asm int<32>: ("gtiu; nip2" : 2 as uint<7>, 1 as uint<7>) == 1);
      }
  },
  PkTest {
    name = "gtl",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("gtl; nip2" : 1L, 2L) == 0);
        assert (asm int<32>: ("gtl; nip2" : 100L, 100L) == 0);
        assert (asm int<32>: ("gtl; nip2" : -200L, -200L) == 0);
        assert (asm int<32>: ("gtl; nip2" : 1 as int<52>, 2 as int<52>) == 0);
        assert (asm int<32>: ("gtl; nip2" : 2 as int<33>, 1 as int<33>) == 1);
      }
  },
  PkTest {
    name = "gtlu",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("gtlu; nip2" : 1UL, 2LU) == 0);
        assert (asm int<32>: ("gtlu; nip2" : 100LU, 100UL) == 0);
        assert (asm int<32>: ("gtlu; nip2" : 1 as uint<52>, 2 as uint<52>) == 0);
        assert (asm int<32>: ("gtlu; nip2" : 2 as uint<33>, 1 as uint<33>) == 1);
      }
  },
  PkTest {
    name = "gts",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("gts; nip2" : "", "") == 0);
        assert (asm int<32>: ("gts; nip2" : "foo", "bar") == 1);
        assert (asm int<32>: ("gts; nip2" : "bar", "foo") == 0);
      }
  },
  PkTest {
    name = "gei",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("gei; nip2" : 1, 2) == 0);
        assert (asm int<32>: ("gei; nip2" : 100, 100) == 1);
        assert (asm int<32>: ("gei; nip2" : -200, -200) == 1);
        assert (asm int<32>: ("gei; nip2" : 1 as int<3>, 2 as int<3>) == 0);
        assert (asm int<32>: ("gei; nip2" : 2 as int<3>, 1 as int<3>) == 1);
      }
  },
  PkTest {
    name = "geiu",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("geiu; nip2" : 1U, 2U) == 0);
        assert (asm int<32>: ("geiu; nip2" : 100U, 100U) == 1);
        assert (asm int<32>: ("geiu; nip2" : 1 as uint<3>, 2 as uint<3>) == 0);
        assert (asm int<32>: ("geiu; nip2" : 2 as uint<7>, 1 as uint<7>) == 1);
      }
  },
  PkTest {
    name = "gel",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("gel; nip2" : 1L, 2L) == 0);
        assert (asm int<32>: ("gel; nip2" : 100L, 100L) == 1);
        assert (asm int<32>: ("gel; nip2" : -200L, -200L) == 1);
        assert (asm int<32>: ("gel; nip2" : 1 as int<52>, 2 as int<52>) == 0);
        assert (asm int<32>: ("gel; nip2" : 2 as int<33>, 1 as int<33>) == 1);
      }
  },
  PkTest {
    name = "gelu",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("gelu; nip2" : 1UL, 2LU) == 0);
        assert (asm int<32>: ("gelu; nip2" : 100LU, 100UL) == 1);
        assert (asm int<32>: ("gelu; nip2" : 1 as uint<52>, 2 as uint<52>) == 0);
        assert (asm int<32>: ("gelu; nip2" : 2 as uint<33>, 1 as uint<33>) == 1);
      }
  },
  PkTest {
    name = "ges",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("ges; nip2" : "", "") == 1);
        assert (asm int<32>: ("ges; nip2" : "foo", "bar") == 1);
        assert (asm int<32>: ("ges; nip2" : "bar", "foo") == 0);
      }
  },
  PkTest {
    name = "nn",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("push 7; nn; nip") == 0);
        assert (asm int<32>: ("nn; nip" : 666) == 1);
      }
  },
  PkTest {
    name = "nnn",
    func = lambda (string name) void:
      {
        assert (asm int<32>: ("push 7; nnn; nip") == 1);
        assert (asm int<32>: ("nnn; nip" : 666) == 0);
      }
  },
  PkTest {
    name = "eqc",
    func = lambda (string name) void:
      {
        fun lala = void: {}
        fun other = void: {}
        assert (asm int<32>: ("eqc; nip2" : (lala), (lala)) == 1);
        assert (asm int<32>: ("eqc; nip2" : (lala), (other)) == 0);
        assert (asm int<32>: ("eqc; nip2" : lambda void: {}, lambda void: {}) == 0);
      }
  },
  PkTest {
    name = "nec",
    func = lambda (string name) void:
      {
        fun lala = void: {}
        fun other = void: {}
        assert (asm int<32>: ("nec; nip2" : (lala), (lala)) == 0);
        assert (asm int<32>: ("nec; nip2" : (lala), (other)) == 1);
        assert (asm int<32>: ("nec; nip2" : lambda void: {}, lambda void: {}) == 1);
      }
  },
  /* Concatenation instructions.  */
  PkTest {
    name = "sconc",
    func = lambda (string name) void:
      {
        var res = asm any: ("sconc; nip2" : "foo", "bar");
        assert (res isa string & res as string == "foobar");
        assert (asm string: ("sconc; nip2" : "", "") == "");
        assert (asm string: ("sconc; nip2" : "", "bleh") == "bleh");
      }
  },
  /* Logical instructions.  */
  PkTest {
    name = "and",
    func = lambda (string name) void:
      {
        var res = asm any: ("and; nip2" : 1, 1);
        assert (res isa int<32> & res as int<32> == 1);
        res = asm any: ("and; nip2" : 1, 0);
        assert (res isa int<32> & res as int<32> == 0);
        res = asm any: ("and; nip2" : 0, -2);
        assert (res isa int<32> & res as int<32> == 0);
        res = asm any: ("and; nip2" : 0, 0);
        assert (res isa int<32> & res as int<32> == 0);
      }
  },
  PkTest {
    name = "or",
    func = lambda (string name) void:
      {
        var res = asm any: ("or; nip2" : 1, 1);
        assert (res isa int<32> & res as int<32> == 1);
        res = asm any: ("or; nip2" : 1, 0);
        assert (res isa int<32> & res as int<32> == 1);
        res = asm any: ("or; nip2" : 0, -2);
        assert (res isa int<32> & res as int<32> == 1);
        res = asm any: ("or; nip2" : 0, 0);
        assert (res isa int<32> & res as int<32> == 0);
      }
  },
  PkTest {
    name = "not",
    func = lambda (string name) void:
      {
        var res = asm any: ("not; nip" : 1);
        assert (res isa int<32> & res as int<32> == 0);
        res = asm any: ("not; nip" : 0);
        assert (res isa int<32> & res as int<32> == 1);
      }
  },
  /* Closure instructions.  */
  PkTest {
    name = "cgetn",
    func = lambda (string name) void:
      {
        fun lala = void: {}
        var fname = asm any: ("cgetn; nip" : (lala));
        assert (fname isa string && fname as string == "lala");
        /* CGETN should return `null' for anonymous closures.  */
        assert (asm int<32>: ("cgetn; nip; nnn; nip" : lambda void: {}));
      }
  },
  /* Miscellaneous instructions.  */
  PkTest {
    name = "gc",
    func = lambda (string name) void:
      {
        asm ("gc");
      }
  },
];

var ok = pktest_run (tests);
exit (ok ? 0 : 1);
