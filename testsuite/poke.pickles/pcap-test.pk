/* pcap-test.pk - Tests for the PCAP pickle.  */

/* Copyright (C) 2022 The poke authors.  */

/* This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

load pktest;
load pcap;

/* Data is a subset of `dns.cap' extracted from
   https://wiki.wireshark.org/SampleCaptures  */

var DNS_DATA = [
  0xd4UB, 0xc3UB, 0xb2UB, 0xa1UB, 0x02UB, 0x00UB, 0x04UB, 0x00UB,
  0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB,
  0xffUB, 0xffUB, 0x00UB, 0x00UB, 0x01UB, 0x00UB, 0x00UB, 0x00UB,
  0xb2UB, 0x67UB, 0x4aUB, 0x42UB, 0xaeUB, 0x91UB, 0x07UB, 0x00UB,
  0x46UB, 0x00UB, 0x00UB, 0x00UB, 0x46UB, 0x00UB, 0x00UB, 0x00UB,
  0x00UB, 0xc0UB, 0x9fUB, 0x32UB, 0x41UB, 0x8cUB, 0x00UB, 0xe0UB,
  0x18UB, 0xb1UB, 0x0cUB, 0xadUB, 0x08UB, 0x00UB, 0x45UB, 0x00UB,
  0x00UB, 0x38UB, 0x00UB, 0x00UB, 0x40UB, 0x00UB, 0x40UB, 0x11UB,
  0x65UB, 0x47UB, 0xc0UB, 0xa8UB, 0xaaUB, 0x08UB, 0xc0UB, 0xa8UB,
  0xaaUB, 0x14UB, 0x80UB, 0x1bUB, 0x00UB, 0x35UB, 0x00UB, 0x24UB,
  0x85UB, 0xedUB, 0x10UB, 0x32UB, 0x01UB, 0x00UB, 0x00UB, 0x01UB,
  0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x06UB, 0x67UB,
  0x6fUB, 0x6fUB, 0x67UB, 0x6cUB, 0x65UB, 0x03UB, 0x63UB, 0x6fUB,
  0x6dUB, 0x00UB, 0x00UB, 0x10UB, 0x00UB, 0x01UB, 0xb2UB, 0x67UB,
  0x4aUB, 0x42UB, 0xc0UB, 0x93UB, 0x07UB, 0x00UB, 0x62UB, 0x00UB,
  0x00UB, 0x00UB, 0x62UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB, 0xe0UB,
  0x18UB, 0xb1UB, 0x0cUB, 0xadUB, 0x00UB, 0xc0UB, 0x9fUB, 0x32UB,
  0x41UB, 0x8cUB, 0x08UB, 0x00UB, 0x45UB, 0x00UB, 0x00UB, 0x54UB,
  0xcbUB, 0xecUB, 0x00UB, 0x00UB, 0x80UB, 0x11UB, 0x99UB, 0x3eUB,
  0xc0UB, 0xa8UB, 0xaaUB, 0x14UB, 0xc0UB, 0xa8UB, 0xaaUB, 0x08UB,
  0x00UB, 0x35UB, 0x80UB, 0x1bUB, 0x00UB, 0x40UB, 0xc7UB, 0x25UB,
  0x10UB, 0x32UB, 0x81UB, 0x80UB, 0x00UB, 0x01UB, 0x00UB, 0x01UB,
  0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x06UB, 0x67UB, 0x6fUB, 0x6fUB,
  0x67UB, 0x6cUB, 0x65UB, 0x03UB, 0x63UB, 0x6fUB, 0x6dUB, 0x00UB,
  0x00UB, 0x10UB, 0x00UB, 0x01UB, 0xc0UB, 0x0cUB, 0x00UB, 0x10UB,
  0x00UB, 0x01UB, 0x00UB, 0x00UB, 0x01UB, 0x0eUB, 0x00UB, 0x10UB,
  0x0fUB, 0x76UB, 0x3dUB, 0x73UB, 0x70UB, 0x66UB, 0x31UB, 0x20UB,
  0x70UB, 0x74UB, 0x72UB, 0x20UB, 0x3fUB, 0x61UB, 0x6cUB, 0x6cUB,
  0xb6UB, 0x67UB, 0x4aUB, 0x42UB, 0x14UB, 0xa6UB, 0x07UB, 0x00UB,
  0x46UB, 0x00UB, 0x00UB, 0x00UB, 0x46UB, 0x00UB, 0x00UB, 0x00UB,
  0x00UB, 0xc0UB, 0x9fUB, 0x32UB, 0x41UB, 0x8cUB, 0x00UB, 0xe0UB,
  0x18UB, 0xb1UB, 0x0cUB, 0xadUB, 0x08UB, 0x00UB, 0x45UB, 0x00UB,
  0x00UB, 0x38UB, 0x00UB, 0x00UB, 0x40UB, 0x00UB, 0x40UB, 0x11UB,
  0x65UB, 0x47UB, 0xc0UB, 0xa8UB, 0xaaUB, 0x08UB, 0xc0UB, 0xa8UB,
  0xaaUB, 0x14UB, 0x80UB, 0x1bUB, 0x00UB, 0x35UB, 0x00UB, 0x24UB,
  0x9eUB, 0xb0UB, 0xf7UB, 0x6fUB, 0x01UB, 0x00UB, 0x00UB, 0x01UB,
  0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x06UB, 0x67UB,
  0x6fUB, 0x6fUB, 0x67UB, 0x6cUB, 0x65UB, 0x03UB, 0x63UB, 0x6fUB,
  0x6dUB, 0x00UB, 0x00UB, 0x0fUB, 0x00UB, 0x01UB, 0xb7UB, 0x67UB,
  0x4aUB, 0x42UB, 0x59UB, 0x16UB, 0x05UB, 0x00UB, 0x2aUB, 0x01UB,
  0x00UB, 0x00UB, 0x2aUB, 0x01UB, 0x00UB, 0x00UB, 0x00UB, 0xe0UB,
  0x18UB, 0xb1UB, 0x0cUB, 0xadUB, 0x00UB, 0xc0UB, 0x9fUB, 0x32UB,
  0x41UB, 0x8cUB, 0x08UB, 0x00UB, 0x45UB, 0x00UB, 0x01UB, 0x1cUB,
  0xccUB, 0xbbUB, 0x00UB, 0x00UB, 0x80UB, 0x11UB, 0x97UB, 0xa7UB,
  0xc0UB, 0xa8UB, 0xaaUB, 0x14UB, 0xc0UB, 0xa8UB, 0xaaUB, 0x08UB,
  0x00UB, 0x35UB, 0x80UB, 0x1bUB, 0x01UB, 0x08UB, 0xd6UB, 0xf3UB,
  0xf7UB, 0x6fUB, 0x81UB, 0x80UB, 0x00UB, 0x01UB, 0x00UB, 0x06UB,
  0x00UB, 0x00UB, 0x00UB, 0x06UB, 0x06UB, 0x67UB, 0x6fUB, 0x6fUB,
  0x67UB, 0x6cUB, 0x65UB, 0x03UB, 0x63UB, 0x6fUB, 0x6dUB, 0x00UB,
  0x00UB, 0x0fUB, 0x00UB, 0x01UB, 0xc0UB, 0x0cUB, 0x00UB, 0x0fUB,
  0x00UB, 0x01UB, 0x00UB, 0x00UB, 0x02UB, 0x28UB, 0x00UB, 0x0aUB,
  0x00UB, 0x28UB, 0x05UB, 0x73UB, 0x6dUB, 0x74UB, 0x70UB, 0x34UB,
  0xc0UB, 0x0cUB, 0xc0UB, 0x0cUB, 0x00UB, 0x0fUB, 0x00UB, 0x01UB,
  0x00UB, 0x00UB, 0x02UB, 0x28UB, 0x00UB, 0x0aUB, 0x00UB, 0x0aUB,
  0x05UB, 0x73UB, 0x6dUB, 0x74UB, 0x70UB, 0x35UB, 0xc0UB, 0x0cUB,
  0xc0UB, 0x0cUB, 0x00UB, 0x0fUB, 0x00UB, 0x01UB, 0x00UB, 0x00UB,
  0x02UB, 0x28UB, 0x00UB, 0x0aUB, 0x00UB, 0x0aUB, 0x05UB, 0x73UB,
  0x6dUB, 0x74UB, 0x70UB, 0x36UB, 0xc0UB, 0x0cUB, 0xc0UB, 0x0cUB,
  0x00UB, 0x0fUB, 0x00UB, 0x01UB, 0x00UB, 0x00UB, 0x02UB, 0x28UB,
  0x00UB, 0x0aUB, 0x00UB, 0x0aUB, 0x05UB, 0x73UB, 0x6dUB, 0x74UB,
  0x70UB, 0x31UB, 0xc0UB, 0x0cUB, 0xc0UB, 0x0cUB, 0x00UB, 0x0fUB,
  0x00UB, 0x01UB, 0x00UB, 0x00UB, 0x02UB, 0x28UB, 0x00UB, 0x0aUB,
  0x00UB, 0x0aUB, 0x05UB, 0x73UB, 0x6dUB, 0x74UB, 0x70UB, 0x32UB,
  0xc0UB, 0x0cUB, 0xc0UB, 0x0cUB, 0x00UB, 0x0fUB, 0x00UB, 0x01UB,
  0x00UB, 0x00UB, 0x02UB, 0x28UB, 0x00UB, 0x0aUB, 0x00UB, 0x28UB,
  0x05UB, 0x73UB, 0x6dUB, 0x74UB, 0x70UB, 0x33UB, 0xc0UB, 0x0cUB,
  0xc0UB, 0x2aUB, 0x00UB, 0x01UB, 0x00UB, 0x01UB, 0x00UB, 0x00UB,
  0x02UB, 0x58UB, 0x00UB, 0x04UB, 0xd8UB, 0xefUB, 0x25UB, 0x1aUB,
  0xc0UB, 0x40UB, 0x00UB, 0x01UB, 0x00UB, 0x01UB, 0x00UB, 0x00UB,
  0x02UB, 0x58UB, 0x00UB, 0x04UB, 0x40UB, 0xe9UB, 0xa7UB, 0x19UB,
  0xc0UB, 0x56UB, 0x00UB, 0x01UB, 0x00UB, 0x01UB, 0x00UB, 0x00UB,
  0x02UB, 0x58UB, 0x00UB, 0x04UB, 0x42UB, 0x66UB, 0x09UB, 0x19UB,
  0xc0UB, 0x6cUB, 0x00UB, 0x01UB, 0x00UB, 0x01UB, 0x00UB, 0x00UB,
  0x02UB, 0x58UB, 0x00UB, 0x04UB, 0xd8UB, 0xefUB, 0x39UB, 0x19UB,
  0xc0UB, 0x82UB, 0x00UB, 0x01UB, 0x00UB, 0x01UB, 0x00UB, 0x00UB,
  0x02UB, 0x58UB, 0x00UB, 0x04UB, 0xd8UB, 0xefUB, 0x25UB, 0x19UB,
  0xc0UB, 0x98UB, 0x00UB, 0x01UB, 0x00UB, 0x01UB, 0x00UB, 0x00UB,
  0x02UB, 0x58UB, 0x00UB, 0x04UB, 0xd8UB, 0xefUB, 0x39UB, 0x1aUB,
  0xbfUB, 0x67UB, 0x4aUB, 0x42UB, 0x8fUB, 0xc7UB, 0x04UB, 0x00UB,
  0x46UB, 0x00UB, 0x00UB, 0x00UB, 0x46UB, 0x00UB, 0x00UB, 0x00UB,
  0x00UB, 0xc0UB, 0x9fUB, 0x32UB, 0x41UB, 0x8cUB, 0x00UB, 0xe0UB,
  0x18UB, 0xb1UB, 0x0cUB, 0xadUB, 0x08UB, 0x00UB, 0x45UB, 0x00UB,
  0x00UB, 0x38UB, 0x00UB, 0x00UB, 0x40UB, 0x00UB, 0x40UB, 0x11UB,
  0x65UB, 0x47UB, 0xc0UB, 0xa8UB, 0xaaUB, 0x08UB, 0xc0UB, 0xa8UB,
  0xaaUB, 0x14UB, 0x80UB, 0x1bUB, 0x00UB, 0x35UB, 0x00UB, 0x24UB,
  0x4cUB, 0x71UB, 0x49UB, 0xa1UB, 0x01UB, 0x00UB, 0x00UB, 0x01UB,
  0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x06UB, 0x67UB,
  0x6fUB, 0x6fUB, 0x67UB, 0x6cUB, 0x65UB, 0x03UB, 0x63UB, 0x6fUB,
  0x6dUB, 0x00UB, 0x00UB, 0x1dUB, 0x00UB, 0x01UB, 0xbfUB, 0x67UB,
  0x4aUB, 0x42UB, 0x9fUB, 0xe6UB, 0x06UB, 0x00UB, 0x46UB, 0x00UB,
  0x00UB, 0x00UB, 0x46UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB, 0xe0UB,
  0x18UB, 0xb1UB, 0x0cUB, 0xadUB, 0x00UB, 0xc0UB, 0x9fUB, 0x32UB,
  0x41UB, 0x8cUB, 0x08UB, 0x00UB, 0x45UB, 0x00UB, 0x00UB, 0x38UB,
  0xccUB, 0xcdUB, 0x00UB, 0x00UB, 0x80UB, 0x11UB, 0x98UB, 0x79UB,
  0xc0UB, 0xa8UB, 0xaaUB, 0x14UB, 0xc0UB, 0xa8UB, 0xaaUB, 0x08UB,
  0x00UB, 0x35UB, 0x80UB, 0x1bUB, 0x00UB, 0x24UB, 0xcbUB, 0xf0UB,
  0x49UB, 0xa1UB, 0x81UB, 0x80UB, 0x00UB, 0x01UB, 0x00UB, 0x00UB,
  0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x06UB, 0x67UB, 0x6fUB, 0x6fUB,
  0x67UB, 0x6cUB, 0x65UB, 0x03UB, 0x63UB, 0x6fUB, 0x6dUB, 0x00UB,
  0x00UB, 0x1dUB, 0x00UB, 0x01UB, 0xc7UB, 0x67UB, 0x4aUB, 0x42UB,
  0x69UB, 0xe5UB, 0x04UB, 0x00UB, 0x55UB, 0x00UB, 0x00UB, 0x00UB,
  0x55UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB, 0xc0UB, 0x9fUB, 0x32UB,
  0x41UB, 0x8cUB, 0x00UB, 0xe0UB, 0x18UB, 0xb1UB, 0x0cUB, 0xadUB,
  0x08UB, 0x00UB, 0x45UB, 0x00UB, 0x00UB, 0x47UB, 0x00UB, 0x00UB,
  0x40UB, 0x00UB, 0x40UB, 0x11UB, 0x65UB, 0x38UB, 0xc0UB, 0xa8UB,
  0xaaUB, 0x08UB, 0xc0UB, 0xa8UB, 0xaaUB, 0x14UB, 0x80UB, 0x1bUB,
  0x00UB, 0x35UB, 0x00UB, 0x33UB, 0x17UB, 0xc2UB, 0x9bUB, 0xbbUB,
  0x01UB, 0x00UB, 0x00UB, 0x01UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB,
  0x00UB, 0x00UB, 0x03UB, 0x31UB, 0x30UB, 0x34UB, 0x01UB, 0x39UB,
  0x03UB, 0x31UB, 0x39UB, 0x32UB, 0x02UB, 0x36UB, 0x36UB, 0x07UB,
  0x69UB, 0x6eUB, 0x2dUB, 0x61UB, 0x64UB, 0x64UB, 0x72UB, 0x04UB,
  0x61UB, 0x72UB, 0x70UB, 0x61UB, 0x00UB, 0x00UB, 0x0cUB, 0x00UB,
  0x01UB, 0xc7UB, 0x67UB, 0x4aUB, 0x42UB, 0x63UB, 0xe7UB, 0x04UB,
  0x00UB, 0x81UB, 0x00UB, 0x00UB, 0x00UB, 0x81UB, 0x00UB, 0x00UB,
  0x00UB, 0x00UB, 0xe0UB, 0x18UB, 0xb1UB, 0x0cUB, 0xadUB, 0x00UB,
  0xc0UB, 0x9fUB, 0x32UB, 0x41UB, 0x8cUB, 0x08UB, 0x00UB, 0x45UB,
  0x00UB, 0x00UB, 0x73UB, 0xcdUB, 0x1bUB, 0x00UB, 0x00UB, 0x80UB,
  0x11UB, 0x97UB, 0xf0UB, 0xc0UB, 0xa8UB, 0xaaUB, 0x14UB, 0xc0UB,
  0xa8UB, 0xaaUB, 0x08UB, 0x00UB, 0x35UB, 0x80UB, 0x1bUB, 0x00UB,
  0x5fUB, 0x82UB, 0xb5UB, 0x9bUB, 0xbbUB, 0x81UB, 0x80UB, 0x00UB,
  0x01UB, 0x00UB, 0x01UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x03UB,
  0x31UB, 0x30UB, 0x34UB, 0x01UB, 0x39UB, 0x03UB, 0x31UB, 0x39UB,
  0x32UB, 0x02UB, 0x36UB, 0x36UB, 0x07UB, 0x69UB, 0x6eUB, 0x2dUB,
  0x61UB, 0x64UB, 0x64UB, 0x72UB, 0x04UB, 0x61UB, 0x72UB, 0x70UB,
  0x61UB, 0x00UB, 0x00UB, 0x0cUB, 0x00UB, 0x01UB, 0xc0UB, 0x0cUB,
  0x00UB, 0x0cUB, 0x00UB, 0x01UB, 0x00UB, 0x01UB, 0x51UB, 0x25UB,
  0x00UB, 0x20UB, 0x0cUB, 0x36UB, 0x36UB, 0x2dUB, 0x31UB, 0x39UB,
  0x32UB, 0x2dUB, 0x39UB, 0x2dUB, 0x31UB, 0x30UB, 0x34UB, 0x03UB,
  0x67UB, 0x65UB, 0x6eUB, 0x09UB, 0x74UB, 0x77UB, 0x74UB, 0x65UB,
  0x6cUB, 0x65UB, 0x63UB, 0x6fUB, 0x6dUB, 0x03UB, 0x6eUB, 0x65UB,
  0x74UB, 0x00UB, 0x0eUB, 0x68UB, 0x4aUB, 0x42UB, 0x7fUB, 0x77UB,
  0x0aUB, 0x00UB, 0x4aUB, 0x00UB, 0x00UB, 0x00UB, 0x4aUB, 0x00UB,
  0x00UB, 0x00UB, 0x00UB, 0xc0UB, 0x9fUB, 0x32UB, 0x41UB, 0x8cUB,
  0x00UB, 0xe0UB, 0x18UB, 0xb1UB, 0x0cUB, 0xadUB, 0x08UB, 0x00UB,
  0x45UB, 0x00UB, 0x00UB, 0x3cUB, 0x00UB, 0x00UB, 0x40UB, 0x00UB,
  0x40UB, 0x11UB, 0x65UB, 0x43UB, 0xc0UB, 0xa8UB, 0xaaUB, 0x08UB,
  0xc0UB, 0xa8UB, 0xaaUB, 0x14UB, 0x80UB, 0x1bUB, 0x00UB, 0x35UB,
  0x00UB, 0x28UB, 0xafUB, 0x61UB, 0x75UB, 0xc0UB, 0x01UB, 0x00UB,
  0x00UB, 0x01UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB, 0x00UB,
  0x03UB, 0x77UB, 0x77UB, 0x77UB, 0x06UB, 0x6eUB, 0x65UB, 0x74UB,
  0x62UB, 0x73UB, 0x64UB, 0x03UB, 0x6fUB, 0x72UB, 0x67UB, 0x00UB,
  0x00UB, 0x01UB, 0x00UB, 0x01UB, 0x0eUB, 0x68UB, 0x4aUB, 0x42UB,
  0x8eUB, 0x36UB, 0x0bUB, 0x00UB, 0x5aUB, 0x00UB, 0x00UB, 0x00UB,
  0x5aUB, 0x00UB, 0x00UB, 0x00UB, 0x00UB, 0xe0UB, 0x18UB, 0xb1UB,
  0x0cUB, 0xadUB, 0x00UB, 0xc0UB, 0x9fUB, 0x32UB, 0x41UB, 0x8cUB,
  0x08UB, 0x00UB, 0x45UB, 0x00UB, 0x00UB, 0x4cUB, 0xcfUB, 0xf9UB,
  0x00UB, 0x00UB, 0x80UB, 0x11UB, 0x95UB, 0x39UB, 0xc0UB, 0xa8UB,
  0xaaUB, 0x14UB, 0xc0UB, 0xa8UB, 0xaaUB, 0x08UB, 0x00UB, 0x35UB,
  0x80UB, 0x1bUB, 0x00UB, 0x38UB, 0xa3UB, 0x17UB, 0x75UB, 0xc0UB,
  0x81UB, 0x80UB, 0x00UB, 0x01UB, 0x00UB, 0x01UB, 0x00UB, 0x00UB,
  0x00UB, 0x00UB, 0x03UB, 0x77UB, 0x77UB, 0x77UB, 0x06UB, 0x6eUB,
  0x65UB, 0x74UB, 0x62UB, 0x73UB, 0x64UB, 0x03UB, 0x6fUB, 0x72UB,
  0x67UB, 0x00UB, 0x00UB, 0x01UB, 0x00UB, 0x01UB, 0xc0UB, 0x0cUB,
  0x00UB, 0x01UB, 0x00UB, 0x01UB, 0x00UB, 0x01UB, 0x40UB, 0xefUB,
  0x00UB, 0x04UB, 0xccUB, 0x98UB, 0xbeUB, 0x0cUB,
];

var tests = [
  PkTest {
    name = "Decode DNS sample in little endian mode",
    func = lambda (string name) void:
      {
        with_temp_ios
          :endian ENDIAN_LITTLE
          :do lambda void:
            {
              byte[] @ 0#B = DNS_DATA;

              var pcap = PCAP @ 0#B,
                  hdr = pcap.header,
                  packets = pcap.packets;

              assert (hdr.magic == [0xd4UB, 0xc3UB, 0xb2UB, 0xa1UB]);
              assert (hdr.snaplen == 65535);
              assert (packets'length == 10);
            };
      },
  },
  PkTest {
    name = "Decode DNS sample in big endian mode",
    func = lambda (string name) void:
      {
        with_temp_ios
          :endian ENDIAN_BIG
          :do lambda void:
            {
              byte[] @ 0#B = DNS_DATA;

              try PCAP @ 0#B;
              catch (Exception ex)
                {
                  assert (ex.code == EC_constraint);
                  assert (ex.msg[39:] == "PCAP_Header.magic");
                  return;
                }
              assert (0, "Unreachable reached!");
            };
      },
  },
];

var ok = pktest_run (tests);
exit (ok ? 0 : 1);
